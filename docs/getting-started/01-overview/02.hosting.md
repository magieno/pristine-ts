Hosting / Execution
-------------------

## How to host
==============
In this section, we'll explore the different ways that Pristine can be hosted.

You can host Pristine under different contexts:
* Function as a Service (Serverless)
* NodeJS Server (Container, Virtual machine or your local machine)
* For scripting purposes by running it directly via the command line

### Function as a Service (Serverless)
======================================

#### AWS Lambda
In the Lambda world, you have two different flows, the Request flow (from API Gateway) that expects a response and the Event flow (all the Lambda triggers). Pristine allows you to reuse code by supporting those two flows out of the box. In the context of a Request, you have to return a response. In the context of an Event, you don't return a response.

Hence, the recommended approach to handle both, is to use the following code.

First, make sure that in your `app.module.ts`, you import the `AwsModule` like this (this should be your new file if you are following this guide from the beginning):
```
import {AwsModule} from "@pristine-ts/aws";
import {CoreModule} from "@pristine-ts/core";

export const AppModule: AppModuleInterface = {
    importServices: [],
    importModules: [
     AwsModule,
     CoreModule,
    ],
    keyname: "my_namespace.app",
}
```
Second, you will need to install the `aws-lambda` package. This will provide you with the types for the Context variable that Lambda is passing to your handler.

Third, create a file named `src/lambda.ts` and include the following code:

```
import "reflect-metadata";
import {AppModule} from './app.module';
import {Kernel} from "@pristine-ts/core";
import {Context} from "aws-lambda";
import {AwsModule, RequestMapper, ResponseMapper} from "@pristine-ts/aws";
import {EnvironmentVariableResolver} from "@pristine-ts/configuration";

let cachedKernel;

export const bootstrapKernel = async () => {
    const kernel = new Kernel();
    await kernel.init(AppModule,
        {
            [AwsModule.keyname + ".region"] : await (new EnvironmentVariableResolver("REGION").resolve()),
        }
    );

    return kernel;
};

export const handler = async (event: any, context: Context) => {
    cachedKernel = cachedKernel ?? await bootstrapKernel();

    try {
        await cachedKernel.handleRawEvent(event);

        return;
    } catch (error) {
        const apiGatewayRequestMapper = cachedKernel.container.resolve(RequestMapper);
        const apiGatewayResponseMapper = cachedKernel.container.resolve(ResponseMapper);

        const request = apiGatewayRequestMapper.map(event);

        return apiGatewayResponseMapper.reverseMap(await cachedKernel.handleRequest(request));
    }
};

```

That's it when you build your project, you should see a `lambda.js` file. This must be the file you referenced as a Lambda handler.

### NodeJS Server
=================

#### Express
If you want to use Express, you will need to install the ExpressModule via npm: `@pristine/express`.

Then, you will need to create a file named `src/express.ts` with the following content:

```
import "reflect-metadata";
import {RequestMapper, ResponseMapper} from "@pristine-ts/express";
import {Kernel} from "@pristine-ts/core";
import {AppModule} from "./app.module";

const express = require('express')
const bodyParser = require('body-parser')
const app = express()
app.use(bodyParser.json({ type: 'application/json' }))
const port = 80 // <-- Configure your port
const kernel = new Kernel();

const bootstrap = () => {
    app.all('*', async (req, res) => {
        const expressRequestMapper = kernel.container.resolve(RequestMapper);
        const expressResponseMapper = kernel.container.resolve(ResponseMapper);

        expressResponseMapper.reverseMap(await kernel.handleRequest(expressRequestMapper.map(req)), res);
    })

    app.listen(port, async () => {
        await kernel.init(AppModule);
    })
}

bootstrap();
```

Then, you can start your Pristine setup hosted under express by running the command:
`ts-node ./src/express.ts`


### Scripting
=============

If you look at the `scr/main.ts` file you created in the previous section, we didn't tell you before, but this was the Scripting hosting. You can use the kernel directly to retrieve your classes from the Container and have their dependencies instantiated automatically. In certain contexts, you don't necessarily want to load an HTTP server, but you want to execute code and still benefit from all the features that Pristine provides. 

Simply access the `container` property from the kernel, resolve your service, and use it!

```
import {AppModule} from './app.module';
import {Kernel} from "@pristine-ts/core";

const bootstrap = async () => {
    const kernel = new Kernel();
    await kernel.init(AppModule);
    
    // Access your classes like this:
    const myService = kernel.container.resolve(MyService);
}

bootstrap();
```


